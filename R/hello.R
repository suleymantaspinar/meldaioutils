# Hello, world!
#
# This is an example function named 'hello'
# which prints 'Hello, world!'.
#
# You can learn more about package authoring with RStudio at:
#
#   http://r-pkgs.had.co.nz/
#
# Some useful keyboard shortcuts for package authoring:
#
#   Install Package:           'Ctrl + Shift + B'
#   Check Package:             'Ctrl + Shift + E'
#   Test Package:              'Ctrl + Shift + T'

hello <- function(){
  print("Hello Melda")
}

melda.findDependency <- function(x){

  tools::package_dependencies(x)

}




#' Load a melda.io json
#'
#This function takes melda.io json file. It gives R code blocks of melda.io json file as output
#'
#' @param meldaJson is filepath.
#' @return returns R code blocks of melda.io json file as a data frame
#' @export
melda.read_object <- function(meldaJson){

  json <- jsonlite::fromJSON(meldaJson,simplifyDataFrame = FALSE)

  temp <- vector(mode = "list",  length = length(json$project$stages))

  print("Json file is read")
  tryCatch({

    for(i in 1:length(json$project$stages)){ #looping for stages // i is the stage number
      print( paste( "Stage number is:", i))
      z <- 1
      for(j in 1:length(json$project$stages[[i]][[8]])){ # for each R code cell in ith stage // j is the cell number
        print( paste( "Stage number is:", i, "cell number is ", j))

        if(json$project$stages[[i]][[8]][[j]]$language == "R"){

          temp[[i]][[z]] <-  json$project$stages[[i]][[8]][[j]]$code


          temp[[i]][[z]] <- as.list(temp[[i]][[z]])
          print( paste( "Stage number is:", i, "cell number is ", j))
          z <- z + 1
        }

      }
    }

  },error = function(e) {
    print(paste("Error in stage number:", i,"and cell number:" , j,e ))
  })

  return(temp)

}



#' Load a Matrix
#'
#This function takes function names as input.
#'
#' @param input function name as a string
#' @return loads the functions' library if it is not loaded.
#' @export
melda.findLibrary <- function(expr){

  if(!is.null(expr) && length(expr) != 0){ #debugging
    chr <- strsplit(expr, "\n" )[[1]]
    temp <- ""
    print(length(chr))
    if( (length(chr) == 1 && grepl("library\\(",chr)) || grepl("require\\(",chr)|| grepl("devtools",chr) || grepl("install.packages\\(",chr)){ #checking for

      print("Library founded")

      y <- regexpr( "\\(.*?\\)" , chr , perl = TRUE)

      div <- regmatches( chr,y )

      return(div)

    }else if( length(chr) > 1){

      for(a in 1:length(chr)){

        if( grepl("library\\(",chr[[a]]) || grepl("require\\(",chr[[a]]) || grepl("devtools",chr[[a]]) ||  grepl("install.packages\\(",chr[[a]])){
          print("Library founded")

          y <- regexpr( "\\(.*?\\)" , chr[[a]] , perl = TRUE)

          div <- regmatches( chr[[a]],y )

          temp <- paste(temp,div,sep = " \n ")

          temp <- sub("\n"," ",temp)



        }


      }

      temp <- rem_dup.one(temp)
      temp <- gsub('"',"",temp)
      temp <- strsplit(temp," ")[[1]]
      return( temp[-1] )

    }else{
      print("Library not found")
      return(NULL)

    }
  }else{
    print("Library not found")
    return(NULL)

  }

}



#' Load a Character Vector
#'
#This function takes function names as input.
#'
#' @param x takes  character vector  as an input
#' @return returns function names as list
#' @export
melda.findFunctionName <- function(chr){
  tryCatch({
  if(is.character(chr)){
      chr <- getInputs(parse(text = chr))
      chr <- chr@functions
      chr <- names(chr)
      return(chr)
  }else{
    "It's not an expression"
  }
  },error = function(e){
    print(e)
  })
}


#' Remove duplicate words
#'
#This function takes character vector and removes
#'the duplicate words.
#' @param x takes  character vector  as an input
#' @return returns non-duplicated words
#' @export

rem_dup.one <- function(x){

  paste(unique(trimws(unlist(strsplit(x,split="(?!')[ [:punct:]]",fixed=F,perl=T)))),collapse = " ")

}


#' Load a melda.io json
#'
#'This function parse the given character vector, searches for "library" keyword in it.
#'
#' @param expr is chr vector.
#' @return returns R code blocks of melda.io json file as a data frame
#' @export
getLibraries <- function(expr,paranthesis = FALSE){

  if(!is.null(expr) && length(expr) != 0){ #debugging
    chr <- strsplit(expr, "\n" )[[1]]
    temp <- ""
    if( length(chr) == 1 && grepl("library\\(",chr)){ #checking for

      print("Library founded")

      temp <- paste(temp,chr,sep="")
      temp <- gsub("\n", "",temp)
      if( paranthesis == TRUE){
        y <- regexpr( "\\(.*?\\)" , temp , perl = TRUE)

        div <- regmatches( temp,y )

        return(div)

      }

      return( temp )

    }else if( length(chr) > 1){

      for(a in 1:length(chr)){

        if( grepl("library",chr[[a]] )){

          print("Library founded")

          temp <- paste(temp,chr[[a]],sep="","\n")

          temp <- gsub("\n", "",temp)

          # return( temp )
        }
      }
      return( temp )

    }else{
      print("Library not found")
      return(NULL)

    }
  }else{
    print("Library not found")
    return(NULL)

  }

}





